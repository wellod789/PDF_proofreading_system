# PDF校正システム プログラム仕様書

## 1. システム概要

### 1.1 目的
PDFファイルの自動校正システムを提供し、誤字脱字や画像配置の問題をAI（Claude 3.5 Sonnet v2）によって検出・修正提案を行う。

### 1.2 対象ファイル
- **ファイル形式**: PDF
- **対象内容**: 文字、画像、図、表
- **用途**: 技術文書、マンガ、サムネイル

### 1.3 システム構成
- **インフラ**: AWS（Amazon Bedrock）
- **AI**: Claude 3.5 Sonnet v2
- **出力形式**: エクセルファイル

## 2. 機能仕様

### 2.1 校正機能

#### 2.1.1 テキスト校正
- **誤字脱字チェック**: 文字の誤りを自動検出
- **文法チェック**: 文法的な不自然さを検出
- **表現チェック**: 不適切な表現や改善提案

#### 2.1.2 画像校正
- **配置チェック**: 画像の配置ミスを検出
- **重複チェック**: 画像の重複配置を検出
- **適切性チェック**: 画像の配置の適切性を評価

### 2.2 ファイル処理機能

#### 2.2.1 PDF読み込み
- **テキスト抽出**: PyPDF2 + pdfplumberを使用
- **画像情報抽出**: 画像の位置・サイズ情報を取得
- **ページ別処理**: ページごとに個別処理

#### 2.2.2 データ処理
- **テキスト分割**: ページ単位でテキストを分割
- **画像情報整理**: 画像の座標・サイズ情報を整理
- **メタデータ保持**: ページ番号などの情報を保持

### 2.3 AI連携機能

#### 2.3.1 AWS Bedrock連携
- **認証**: AWS認証情報を使用
- **API呼び出し**: Claude 3.5 Sonnet v2を呼び出し
- **プロンプト管理**: 校正用プロンプトを動的生成

#### 2.3.2 校正プロンプト
```
テキスト校正用プロンプト:
- 誤字脱字の検出と修正提案
- 文法・表現の改善提案
- その他の気になる点の指摘

画像校正用プロンプト:
- 配置問題の検出
- 修正提案の提供
- その他の気になる点の指摘
```

### 2.4 出力機能

#### 2.4.1 エクセル出力
- **ファイル形式**: .xlsx
- **シート構成**: 校正結果シート
- **列構成**: ページ、タイプ、内容、校正結果

#### 2.4.2 データ構造
| 列名 | データ型 | 説明 |
|------|----------|------|
| ページ | 数値 | ページ番号 |
| タイプ | 文字列 | text/image |
| 内容 | 文字列 | 抽出された内容 |
| 校正結果 | 文字列 | AIによる校正結果 |

## 3. システム構成

### 3.1 アーキテクチャ

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web Browser   │    │   Flask App     │    │  AWS Bedrock    │
│                 │    │                 │    │                 │
│  - File Upload  │◄──►│  - PDF Process  │◄──►│  - Claude 3.5   │
│  - Result View  │    │  - AI Integration│    │  - Correction   │
│  - Download     │    │  - Excel Export │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 3.2 ディレクトリ構成

```
aws_kousei/
├── app.py                 # メインアプリケーション
├── config.py              # 設定ファイル
├── requirements.txt       # 依存関係
├── README.md             # ドキュメント
├── プログラム仕様書.md    # 本仕様書
├── templates/
│   └── index.html        # Web UI
├── static/
│   ├── css/              # CSSファイル
│   └── js/               # JavaScriptファイル
├── uploads/              # アップロード一時ファイル
└── outputs/              # 出力ファイル
```

### 3.3 主要モジュール

#### 3.3.1 app.py
- **Flask アプリケーション**: Webサーバー機能
- **ルーティング**: URLマッピング
- **ファイル処理**: アップロード・ダウンロード処理

#### 3.3.2 PDFCorrector クラス
```python
class PDFCorrector:
    def extract_text_from_pdf(self, pdf_path)
    def extract_images_from_pdf(self, pdf_path)
    def check_with_claude(self, content, content_type)
    def process_pdf(self, pdf_path)
    def export_to_excel(self, output_path)
```

## 4. 技術仕様

### 4.1 使用技術

#### 4.1.1 Backend
- **Python**: 3.8以上
- **Flask**: 2.3.3
- **boto3**: 1.28.62（AWS SDK）

#### 4.1.2 PDF処理
- **PyPDF2**: 3.0.1
- **pdfplumber**: 0.9.0
- **Pillow**: 10.0.1

#### 4.1.3 データ処理
- **openpyxl**: 3.1.2（Excel出力）
- **python-dotenv**: 1.0.0（環境変数管理）

#### 4.1.4 Frontend
- **Bootstrap**: 5.1.3
- **Font Awesome**: 6.0.0
- **JavaScript**: ES6+

### 4.2 AWS設定

#### 4.2.1 必要な権限
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "bedrock:InvokeModel"
            ],
            "Resource": "arn:aws:bedrock:us-east-1::foundation-model/anthropic.claude-3-5-sonnet-20241022-v2:0"
        }
    ]
}
```

#### 4.2.2 環境変数
```
AWS_ACCESS_KEY_ID=your_access_key_here
AWS_SECRET_ACCESS_KEY=your_secret_key_here
AWS_DEFAULT_REGION=us-east-1
```

### 4.3 パフォーマンス仕様

#### 4.3.1 処理能力
- **ファイルサイズ制限**: 16MB
- **同時処理**: 1ファイル（シーケンシャル処理）
- **処理時間**: ファイルサイズに依存（目安：1MB/分）

#### 4.3.2 メモリ使用量
- **基本使用量**: 約100MB
- **PDF処理時**: ファイルサイズの2-3倍
- **推奨メモリ**: 512MB以上

## 5. API仕様

### 5.1 エンドポイント

#### 5.1.1 GET /
- **説明**: メインページ表示
- **レスポンス**: HTMLページ

#### 5.1.2 POST /upload
- **説明**: PDFファイルアップロード・処理
- **リクエスト**: multipart/form-data
- **レスポンス**: JSON
```json
{
    "success": true,
    "corrections": [
        {
            "type": "text",
            "page": 1,
            "content": "抽出されたテキスト...",
            "correction": "AIによる校正結果..."
        }
    ],
    "excel_file": "校正結果_20240911_180000.xlsx"
}
```

#### 5.1.3 GET /download/<filename>
- **説明**: エクセルファイルダウンロード
- **レスポンス**: ファイルダウンロード

### 5.2 エラーハンドリング

#### 5.2.1 エラーコード
- **400**: 不正なリクエスト
- **500**: サーバーエラー

#### 5.2.2 エラーメッセージ
```json
{
    "error": "エラーメッセージ"
}
```

## 6. セキュリティ仕様

### 6.1 ファイルセキュリティ
- **ファイル形式検証**: PDFファイルのみ許可
- **ファイルサイズ制限**: 16MB
- **一時ファイル管理**: 処理後即座に削除

### 6.2 AWS認証
- **認証情報**: 環境変数で管理
- **権限最小化**: 必要最小限の権限のみ
- **暗号化**: HTTPS通信

## 7. 運用仕様

### 7.1 起動方法
```bash
# 仮想環境作成
python -m venv venv

# 仮想環境有効化
.\venv\Scripts\activate

# 依存関係インストール
pip install -r requirements.txt

# アプリケーション起動
python app.py
```

### 7.2 ログ管理
- **ログレベル**: INFO
- **ログ出力**: コンソール
- **エラーログ**: 詳細なエラー情報を出力

### 7.3 監視項目
- **CPU使用率**: 処理時の負荷監視
- **メモリ使用量**: メモリリーク監視
- **処理時間**: ファイル処理時間の監視

## 8. 制限事項

### 8.1 技術的制限
- **ファイル形式**: PDFのみ対応
- **言語**: 日本語を想定（英語も対応可能）
- **画像形式**: PDF内埋め込み画像のみ

### 8.2 運用制限
- **同時処理**: 1ファイルのみ
- **ファイル保持**: 一時ファイルは即座に削除
- **AWS制限**: Bedrockの利用制限に依存

## 9. 今後の拡張予定

### 9.1 機能拡張
- **複数ファイル処理**: バッチ処理機能
- **カスタムプロンプト**: ユーザー定義校正ルール
- **履歴管理**: 処理履歴の保存・参照

### 9.2 性能向上
- **非同期処理**: バックグラウンド処理
- **キャッシュ機能**: 類似ファイルの処理結果キャッシュ
- **並列処理**: 複数ファイルの並列処理

## 10. トラブルシューティング

### 10.1 よくある問題

#### 10.1.1 AWS認証エラー
- **原因**: 認証情報の設定ミス
- **解決方法**: .envファイルの確認

#### 10.1.2 PDF読み込みエラー
- **原因**: 破損したPDFファイル
- **解決方法**: ファイルの再作成

#### 10.1.3 メモリ不足エラー
- **原因**: 大きなPDFファイルの処理
- **解決方法**: ファイルサイズの削減

### 10.2 ログ確認方法
```bash
# アプリケーションログの確認
python app.py 2>&1 | tee app.log
```

---

**作成日**: 2024年9月11日  
**バージョン**: 1.0  
**作成者**: AI Assistant
